name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  CARGO_TERM_COLOR: always

jobs:
  zizmor:
    name: Workflow Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: zizmorcore/zizmor-action@135698455da5c3b3e55f73f4419e481ab68cdd95 # v0.4.1
        with:
          advanced-security: false
          online-audits: false

  biome:
    name: Biome
    needs: zizmor
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: biomejs/setup-biome@b2d22cfd9a11c0950398a316e08e17cf3891e85c # v2.7.0
        with:
          version: "2.3.13"
      - run: biome ci crates/gateway/src/assets/js/

  fmt:
    name: Format
    needs: zizmor
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    needs: fmt
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - name: Clean up corrupted cargo config
        run: rm -f ~/.cargo/config.toml
      - name: Install build dependencies for llama.cpp
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libclang-dev pkg-config nvidia-cuda-toolkit nvidia-cuda-dev
          nvcc --version
      - name: Configure CUDA linker paths
        run: |
          sudo mkdir -p /usr/local/cuda/lib64 /usr/local/cuda/include
          if [ -f /usr/include/cuda.h ]; then
            sudo ln -sf /usr/include/cuda.h /usr/local/cuda/include/cuda.h
          fi
          for lib in libcudart_static.a libcublas_static.a libcublasLt_static.a libculibos.a; do
            if [ -f "/usr/lib/x86_64-linux-gnu/${lib}" ]; then
              sudo ln -sf "/usr/lib/x86_64-linux-gnu/${lib}" "/usr/local/cuda/lib64/${lib}"
            fi
          done
          echo "CUDA_PATH=/usr/local/cuda" >> "$GITHUB_ENV"
          echo "CUDA_ROOT=/usr/local/cuda" >> "$GITHUB_ENV"
          echo "CUDA_LIBRARY_PATH=/usr/local/cuda" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/lib64/stubs:/usr/lib/x86_64-linux-gnu" >> "$GITHUB_ENV"
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          components: clippy
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
      - name: Initialize git repo in llama-cpp source to satisfy cmake
        run: |
          # llama-cpp-sys-2's cmake build runs git commands that fail without a repo
          # We need to fetch the crate first so the source exists
          cargo fetch --locked
          LLAMA_SRC=$(find ~/.cargo/registry/src -name "llama-cpp-sys-2-*" -type d 2>/dev/null | head -1)
          if [ -n "$LLAMA_SRC" ] && [ ! -d "$LLAMA_SRC/.git" ]; then
            cd "$LLAMA_SRC"
            git init
            git config user.email "ci@example.com"
            git config user.name "CI"
            git add -A
            git commit -m "init" --allow-empty
            git tag v0.0.0
          fi
      # Lint with all features enabled on Linux CI runners.
      - run: cargo clippy --all-features --all-targets -- -D warnings

  build:
    name: Build & Test
    needs: [clippy, biome]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - name: Clean up corrupted cargo config
        run: rm -f ~/.cargo/config.toml
      - name: Install build dependencies for llama.cpp
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libclang-dev pkg-config nvidia-cuda-toolkit nvidia-cuda-dev
          nvcc --version
      - name: Configure CUDA linker paths
        run: |
          sudo mkdir -p /usr/local/cuda/lib64 /usr/local/cuda/include
          if [ -f /usr/include/cuda.h ]; then
            sudo ln -sf /usr/include/cuda.h /usr/local/cuda/include/cuda.h
          fi
          for lib in libcudart_static.a libcublas_static.a libcublasLt_static.a libculibos.a; do
            if [ -f "/usr/lib/x86_64-linux-gnu/${lib}" ]; then
              sudo ln -sf "/usr/lib/x86_64-linux-gnu/${lib}" "/usr/local/cuda/lib64/${lib}"
            fi
          done
          echo "CUDA_PATH=/usr/local/cuda" >> "$GITHUB_ENV"
          echo "CUDA_ROOT=/usr/local/cuda" >> "$GITHUB_ENV"
          echo "CUDA_LIBRARY_PATH=/usr/local/cuda" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/lib64/stubs:/usr/lib/x86_64-linux-gnu" >> "$GITHUB_ENV"
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
      - name: Initialize git repo in llama-cpp source to satisfy cmake
        run: |
          cargo fetch --locked
          LLAMA_SRC=$(find ~/.cargo/registry/src -name "llama-cpp-sys-2-*" -type d 2>/dev/null | head -1)
          if [ -n "$LLAMA_SRC" ] && [ ! -d "$LLAMA_SRC/.git" ]; then
            cd "$LLAMA_SRC"
            git init
            git config user.email "ci@example.com"
            git config user.name "CI"
            git add -A
            git commit -m "init" --allow-empty
            git tag v0.0.0
          fi
      # Build and test with all features enabled on Linux CI runners.
      - run: cargo build --all-features --all-targets
      - run: cargo test --all-features
